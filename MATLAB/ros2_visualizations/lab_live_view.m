function lab_live_view



    clc
    tcp = tcpip('127.0.0.1', 1234);
    tcp.InputBufferSize = 2^15;
    fopen(tcp);
    finishup = onCleanup(@()fclose(tcp));
    
    
    vehicles = struct('id',{},'observation',{},'command',{});
    
    clf
    hold on
    
    path_x = [1.995935,2.052770,2.109605,2.166434,2.223246,2.280019,2.336717,2.393287,2.449653,2.505716,2.561350,2.616398,2.670669,2.723938,2.775942,2.826381,2.874916,2.921170,2.964734,3.005165,3.041807,3.066144,3.088206,3.107897,3.125129,3.139827,3.151926,3.161374,3.168129,3.172160,3.173451,3.171995,3.167800,3.160883,3.151275,3.139018,3.124166,3.106784,3.086949,3.064747,3.039897,3.002836,2.962204,2.918466,2.872064,2.823405,2.772863,2.720775,2.667439,2.613115,2.558027,2.502363,2.446278,2.389898,2.333318,2.276614,2.219838,2.163024,2.106195,2.049360,1.993858,1.959229,1.924601,1.889973,1.855345,1.820717,1.786089,1.751460,1.716832,1.682204,1.647576,1.612948,1.578320,1.543692,1.509063,1.474435,1.439807,1.405179,1.370551,1.335923,1.299518,1.242683,1.185849,1.129021,1.072211,1.015442,0.958752,0.902195,0.845849,0.789815,0.734222,0.679229,0.625029,0.571851,0.519961,0.469661,0.421295,0.375240,0.331910,0.291750,0.256165,0.232006,0.210130,0.190633,0.173601,0.159109,0.147220,0.137986,0.131448,0.127636,0.126564,0.128240,0.132654,0.139787,0.149609,0.162076,0.177133,0.194714,0.214742,0.237128,0.262925,0.300289,0.341187,0.385153,0.431751,0.480574,0.531251,0.583450,0.636874,0.691266,0.746407,0.802110,0.858223,0.914623,0.971214,1.027926,1.084706,1.141522,1.198352,1.255187,1.308913,1.343541,1.378169,1.412797,1.447425,1.482053,1.516682,1.551310,1.585938,1.620566,1.655194,1.689822,1.724451,1.759079,1.793707,1.828335,1.862963,1.897591,1.932219,1.966848,2.005029,2.061864,2.118698,2.175525,2.232333,2.289097,2.345779,2.402321,2.458646,2.514650,2.570202,2.625139,2.679266,2.732351,2.784126,2.834284,2.882480,2.928332,2.971425,3.011312,3.048930,3.087562,3.119467,3.144245,3.161589,3.171281,3.173200,3.167323,3.153724,3.132570,3.104128,3.068751,3.026881,2.979040,2.925827,2.867904,2.805994,2.740870,2.673345,2.604262,2.537086,2.480379,2.424180,2.368840,2.314642,2.261808,2.210497,2.160818,2.112824,2.066530,2.021907,1.978893,1.937397,1.897301,1.858467,1.820737,1.783940,1.747894,1.712406,1.677279,1.650001,1.650001,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.649999,1.641611,1.606595,1.571327,1.535606,1.499238,1.462034,1.423816,1.384420,1.343696,1.301515,1.257771,1.212385,1.165310,1.116537,1.066097,1.014069,0.960584,0.905830,0.850055,0.793575,0.726004,0.628532,0.534096,0.445024,0.363515,0.291580,0.230994,0.183251,0.149529,0.130661,0.127111,0.138968,0.165939,0.207358,0.262204,0.329123,0.406464,0.492320,0.584571,0.680942,0.767460,0.824140,0.880283,0.935541,0.989637,1.042355,1.093538,1.143084,1.190942,1.237101,1.281592,1.324481,1.365860,1.405850,1.444590,1.482239,1.518969,1.554963,1.590415,1.625522,1.649999,1.649999,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650000,1.650001,1.661186,1.696215,1.731512,1.767277,1.803705,1.840984,1.879290,1.918787,1.959623,2.001926,2.045799,2.091319,2.138529,2.187438,2.238008,2.290158,2.343752,2.398598,2.454442,2.510963,2.562540,2.603906,2.645028,2.685726,2.725821,2.765137,2.803500,2.840742,2.876701,2.911216,2.944138,2.975321,3.004629,3.031931,3.057110,3.080053,3.100660,3.118841,3.134515,3.147614,];
    path_y = [0.141523,0.141566,0.141867,0.142687,0.144282,0.146910,0.150831,0.156297,0.163563,0.172876,0.184476,0.198596,0.215452,0.235246,0.258154,0.284326,0.313878,0.346882,0.383361,0.423281,0.466300,0.499829,0.534896,0.571348,0.609025,0.647760,0.687385,0.727723,0.768599,0.809833,0.851243,0.892648,0.933865,0.974714,1.015015,1.054591,1.093267,1.130875,1.167248,1.202228,1.236144,1.279210,1.318926,1.355197,1.387992,1.417338,1.443311,1.466028,1.485640,1.502326,1.516289,1.527745,1.536928,1.544079,1.549446,1.553281,1.555841,1.557382,1.558163,1.558442,1.558477,1.558477,1.558477,1.558477,1.558477,1.558477,1.558477,1.558477,1.558477,1.558477,1.558477,1.558477,1.558477,1.558477,1.558477,1.558477,1.558477,1.558477,1.558477,1.558477,1.558477,1.558423,1.558089,1.557218,1.555550,1.552827,1.548792,1.543191,1.535771,1.526284,1.514490,1.500159,1.483075,1.463039,1.439874,1.413435,1.383609,1.350328,1.313571,1.273379,1.231078,1.197421,1.162236,1.125680,1.087913,1.049100,1.009412,0.969024,0.928113,0.886858,0.845442,0.804045,0.762851,0.722039,0.681790,0.642280,0.603683,0.566168,0.529900,0.495039,0.460291,0.417488,0.378045,0.342052,0.309534,0.280461,0.254753,0.232291,0.212920,0.196459,0.182706,0.171440,0.162428,0.155429,0.150194,0.146471,0.144002,0.142531,0.141800,0.141550,0.141523,0.141523,0.141523,0.141523,0.141523,0.141523,0.141523,0.141523,0.141523,0.141523,0.141523,0.141523,0.141523,0.141523,0.141523,0.141523,0.141523,0.141523,0.141523,0.141523,0.141523,0.141590,0.141957,0.142883,0.144626,0.147444,0.151595,0.157332,0.164909,0.174572,0.186560,0.201104,0.218417,0.238697,0.262119,0.288825,0.318925,0.352485,0.389518,0.429982,0.475638,0.533796,0.595899,0.661173,0.728804,0.797947,0.867740,0.937311,1.005793,1.072331,1.136094,1.196286,1.252158,1.303011,1.348210,1.387193,1.419471,1.444643,1.462394,1.472503,1.474897,1.471357,1.462988,1.450103,1.433034,1.412118,1.387698,1.360109,1.329678,1.296718,1.261527,1.224384,1.185552,1.145275,1.103779,1.061276,1.017961,0.974020,0.929626,0.884946,0.850001,0.850001,0.850001,0.850001,0.850000,0.850000,0.850000,0.850000,0.850000,0.850000,0.850000,0.850000,0.850000,0.850000,0.850000,0.850000,0.850000,0.849999,0.849999,0.849999,0.839243,0.794476,0.749907,0.705700,0.662025,0.619061,0.576996,0.536033,0.496391,0.458305,0.422026,0.387826,0.355991,0.326828,0.300655,0.277805,0.258616,0.243430,0.232582,0.226397,0.225522,0.237226,0.264048,0.305327,0.360045,0.426851,0.504097,0.589878,0.682076,0.778418,0.876526,0.973979,1.068373,1.157380,1.238802,1.310632,1.371097,1.418705,1.452282,1.470999,1.474798,1.470861,1.462119,1.448887,1.431497,1.410289,1.385603,1.357775,1.327130,1.293981,1.258623,1.221336,1.182380,1.141997,1.100413,1.057838,1.014467,0.970483,0.926060,0.881364,0.850001,0.850001,0.850001,0.850000,0.850000,0.850000,0.850000,0.850000,0.850000,0.850000,0.850000,0.850000,0.850000,0.850000,0.850000,0.850000,0.850000,0.849999,0.849999,0.849999,0.835659,0.790901,0.746355,0.702185,0.658560,0.615660,0.573675,0.532810,0.493284,0.455333,0.419210,0.385188,0.353556,0.324620,0.298700,0.276131,0.257249,0.242398,0.231912,0.226113,0.225159,0.227465,0.232507,0.240262,0.250696,0.263764,0.279408,0.297559,0.318137,0.341053,0.366205,0.393483,0.422767,0.453928,0.486830,0.521328,0.557269,0.594497,0.632848,0.672153,];

    plot(path_x, path_y);

    h_patch = patch(0,0,'green');
    h_plot = plot(0,0,'red','LineWidth',3);
    axis equal
    xlim(xlim + [-1 1]*0.5)
    ylim(ylim + [-1 1]*0.5)
    
    
    while true
        messages = read_json_tcp(tcp);
        for message = messages
            % sort new messages
            if startsWith(message.topic, '/vehicle')
                id = message.topic(9:10);
                index = find(strcmp({vehicles.id},id));
                if isempty(index)
                    vehicles(end+1).id = id;
                    index = length(vehicles);
                end
                
                if endsWith(message.topic, 'command')
                    vehicles(index).command = message;
                elseif endsWith(message.topic, 'observation')
                    vehicles(index).observation = message;
                end
            end
        end
        
        % update visualization
        if ~isempty(messages) && ~isempty(vehicles)
            observation_available = false;
            command_available = false;
            try
                x = arrayfun(@(i)vehicles(i).observation.message.pose.position.x,1:length(vehicles));
                y = arrayfun(@(i)vehicles(i).observation.message.pose.position.y,1:length(vehicles));
                qz = arrayfun(@(i)vehicles(i).observation.message.pose.orientation.z,1:length(vehicles));
                qw = arrayfun(@(i)vehicles(i).observation.message.pose.orientation.w,1:length(vehicles));
                observation_available = true;
            end
            try
                curvature = arrayfun(@(i)vehicles(i).command.message.curvature,1:length(vehicles));
                speed = arrayfun(@(i)vehicles(i).command.message.speed,1:length(vehicles));
                command_available = true;
            end
            
            if observation_available
                N = length(x);
                sin_yaw = 2 .* qw .* qz;
                cos_yaw = qw.^2 - qz.^2;
                polygon_x = nan(4, N);
                polygon_y = nan(4, N);
                lines_x = nan(3*N,1);
                lines_y = nan(3*N,1);
                for i=1:N
                    vehicle_transform = [...
                        cos_yaw(i) -sin_yaw(i)  x(i); ...
                        sin_yaw(i)  cos_yaw(i)  y(i); ...
                                 0           0     1; ];
                    vehicle_rect = vehicle_transform * [0.19 0.045 1; 0.19 -0.045 1; -0.03 -0.045 1; -0.03 0.045 1]';
                    polygon_x(:,i) = vehicle_rect(1,:)';
                    polygon_y(:,i) = vehicle_rect(2,:)';
                    
                    if command_available
                        line_command = vehicle_transform * [0.15 0 1; 0.15 0.1*curvature(i) 1]';
                        lines_x(3*i-2:3*i-1) = line_command(1,:)';
                        lines_y(3*i-2:3*i-1) = line_command(2,:)';
                    end
                end
                
                set(h_plot, 'XData', lines_x);
                set(h_plot, 'YData', lines_y);
                set(h_patch, 'XData', polygon_x);
                set(h_patch, 'YData', polygon_y);
            end
            
            drawnow
        end
        
    end
    
end